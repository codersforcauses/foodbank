{"ast":null,"code":"\"use strict\";\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar Util_1 = require(\"./Util\");\n\nvar Factory_1 = require(\"./Factory\");\n\nvar Container_1 = require(\"./Container\");\n\nvar Global_1 = require(\"./Global\");\n\nvar Canvas_1 = require(\"./Canvas\");\n\nvar DragAndDrop_1 = require(\"./DragAndDrop\");\n\nvar Global_2 = require(\"./Global\");\n\nvar PointerEvents = require(\"./PointerEvents\");\n\nvar STAGE = 'Stage',\n    STRING = 'string',\n    PX = 'px',\n    MOUSEOUT = 'mouseout',\n    MOUSELEAVE = 'mouseleave',\n    MOUSEOVER = 'mouseover',\n    MOUSEENTER = 'mouseenter',\n    MOUSEMOVE = 'mousemove',\n    MOUSEDOWN = 'mousedown',\n    MOUSEUP = 'mouseup',\n    POINTERMOVE = 'pointermove',\n    POINTERDOWN = 'pointerdown',\n    POINTERUP = 'pointerup',\n    POINTERCANCEL = 'pointercancel',\n    LOSTPOINTERCAPTURE = 'lostpointercapture',\n    CONTEXTMENU = 'contextmenu',\n    CLICK = 'click',\n    DBL_CLICK = 'dblclick',\n    TOUCHSTART = 'touchstart',\n    TOUCHEND = 'touchend',\n    TAP = 'tap',\n    DBL_TAP = 'dbltap',\n    TOUCHMOVE = 'touchmove',\n    WHEEL = 'wheel',\n    CONTENT_MOUSEOUT = 'contentMouseout',\n    CONTENT_MOUSEOVER = 'contentMouseover',\n    CONTENT_MOUSEMOVE = 'contentMousemove',\n    CONTENT_MOUSEDOWN = 'contentMousedown',\n    CONTENT_MOUSEUP = 'contentMouseup',\n    CONTENT_CONTEXTMENU = 'contentContextmenu',\n    CONTENT_CLICK = 'contentClick',\n    CONTENT_DBL_CLICK = 'contentDblclick',\n    CONTENT_TOUCHSTART = 'contentTouchstart',\n    CONTENT_TOUCHEND = 'contentTouchend',\n    CONTENT_DBL_TAP = 'contentDbltap',\n    CONTENT_TAP = 'contentTap',\n    CONTENT_TOUCHMOVE = 'contentTouchmove',\n    CONTENT_POINTERMOVE = 'contentPointermove',\n    CONTENT_POINTERDOWN = 'contentPointerdown',\n    CONTENT_POINTERUP = 'contentPointerup',\n    CONTENT_WHEEL = 'contentWheel',\n    RELATIVE = 'relative',\n    KONVA_CONTENT = 'konvajs-content',\n    SPACE = ' ',\n    UNDERSCORE = '_',\n    CONTAINER = 'container',\n    MAX_LAYERS_NUMBER = 5,\n    EMPTY_STRING = '',\n    EVENTS = [MOUSEENTER, MOUSEDOWN, MOUSEMOVE, MOUSEUP, MOUSEOUT, TOUCHSTART, TOUCHMOVE, TOUCHEND, MOUSEOVER, WHEEL, CONTEXTMENU, POINTERDOWN, POINTERMOVE, POINTERUP, POINTERCANCEL, LOSTPOINTERCAPTURE],\n    eventsLength = EVENTS.length;\n\nfunction addEvent(ctx, eventName) {\n  ctx.content.addEventListener(eventName, function (evt) {\n    ctx[UNDERSCORE + eventName](evt);\n  }, false);\n}\n\nvar NO_POINTERS_MESSAGE = \"Pointer position is missing and not registered by the stage. Looks like it is outside of the stage container. You can set it manually from event: stage.setPointersPositions(event);\";\nexports.stages = [];\n\nfunction checkNoClip(attrs) {\n  if (attrs === void 0) {\n    attrs = {};\n  }\n\n  if (attrs.clipFunc || attrs.clipWidth || attrs.clipHeight) {\n    Util_1.Util.warn('Stage does not support clipping. Please use clip for Layers or Groups.');\n  }\n\n  return attrs;\n}\n\nvar Stage = function (_super) {\n  __extends(Stage, _super);\n\n  function Stage(config) {\n    var _this = _super.call(this, checkNoClip(config)) || this;\n\n    _this._pointerPositions = [];\n    _this._changedPointerPositions = [];\n\n    _this._buildDOM();\n\n    _this._bindContentEvents();\n\n    exports.stages.push(_this);\n\n    _this.on('widthChange.konva heightChange.konva', _this._resizeDOM);\n\n    _this.on('visibleChange.konva', _this._checkVisibility);\n\n    _this.on('clipWidthChange.konva clipHeightChange.konva clipFuncChange.konva', function () {\n      checkNoClip(_this.attrs);\n    });\n\n    _this._checkVisibility();\n\n    return _this;\n  }\n\n  Stage.prototype._validateAdd = function (child) {\n    var isLayer = child.getType() === 'Layer';\n    var isFastLayer = child.getType() === 'FastLayer';\n    var valid = isLayer || isFastLayer;\n\n    if (!valid) {\n      Util_1.Util.throw('You may only add layers to the stage.');\n    }\n  };\n\n  Stage.prototype._checkVisibility = function () {\n    if (!this.content) {\n      return;\n    }\n\n    var style = this.visible() ? '' : 'none';\n    this.content.style.display = style;\n  };\n\n  Stage.prototype.setContainer = function (container) {\n    if (typeof container === STRING) {\n      if (container.charAt(0) === '.') {\n        var className = container.slice(1);\n        container = document.getElementsByClassName(className)[0];\n      } else {\n        var id;\n\n        if (container.charAt(0) !== '#') {\n          id = container;\n        } else {\n          id = container.slice(1);\n        }\n\n        container = document.getElementById(id);\n      }\n\n      if (!container) {\n        throw 'Can not find container in document with id ' + id;\n      }\n    }\n\n    this._setAttr(CONTAINER, container);\n\n    if (this.content) {\n      if (this.content.parentElement) {\n        this.content.parentElement.removeChild(this.content);\n      }\n\n      container.appendChild(this.content);\n    }\n\n    return this;\n  };\n\n  Stage.prototype.shouldDrawHit = function () {\n    return true;\n  };\n\n  Stage.prototype.clear = function () {\n    var layers = this.children,\n        len = layers.length,\n        n;\n\n    for (n = 0; n < len; n++) {\n      layers[n].clear();\n    }\n\n    return this;\n  };\n\n  Stage.prototype.clone = function (obj) {\n    if (!obj) {\n      obj = {};\n    }\n\n    obj.container = document.createElement('div');\n    return Container_1.Container.prototype.clone.call(this, obj);\n  };\n\n  Stage.prototype.destroy = function () {\n    _super.prototype.destroy.call(this);\n\n    var content = this.content;\n\n    if (content && Util_1.Util._isInDocument(content)) {\n      this.container().removeChild(content);\n    }\n\n    var index = exports.stages.indexOf(this);\n\n    if (index > -1) {\n      exports.stages.splice(index, 1);\n    }\n\n    return this;\n  };\n\n  Stage.prototype.getPointerPosition = function () {\n    var pos = this._pointerPositions[0] || this._changedPointerPositions[0];\n\n    if (!pos) {\n      Util_1.Util.warn(NO_POINTERS_MESSAGE);\n      return null;\n    }\n\n    return {\n      x: pos.x,\n      y: pos.y\n    };\n  };\n\n  Stage.prototype._getPointerById = function (id) {\n    return this._pointerPositions.find(function (p) {\n      return p.id === id;\n    });\n  };\n\n  Stage.prototype.getPointersPositions = function () {\n    return this._pointerPositions;\n  };\n\n  Stage.prototype.getStage = function () {\n    return this;\n  };\n\n  Stage.prototype.getContent = function () {\n    return this.content;\n  };\n\n  Stage.prototype._toKonvaCanvas = function (config) {\n    config = config || {};\n    config.x = config.x || 0;\n    config.y = config.y || 0;\n    config.width = config.width || this.width();\n    config.height = config.height || this.height();\n    var canvas = new Canvas_1.SceneCanvas({\n      width: config.width,\n      height: config.height,\n      pixelRatio: config.pixelRatio || 1\n    });\n\n    var _context = canvas.getContext()._context;\n\n    var layers = this.children;\n\n    if (config.x || config.y) {\n      _context.translate(-1 * config.x, -1 * config.y);\n    }\n\n    layers.each(function (layer) {\n      if (!layer.isVisible()) {\n        return;\n      }\n\n      var layerCanvas = layer._toKonvaCanvas(config);\n\n      _context.drawImage(layerCanvas._canvas, config.x, config.y, layerCanvas.getWidth() / layerCanvas.getPixelRatio(), layerCanvas.getHeight() / layerCanvas.getPixelRatio());\n    });\n    return canvas;\n  };\n\n  Stage.prototype.getIntersection = function (pos, selector) {\n    if (!pos) {\n      return null;\n    }\n\n    var layers = this.children,\n        len = layers.length,\n        end = len - 1,\n        n,\n        shape;\n\n    for (n = end; n >= 0; n--) {\n      shape = layers[n].getIntersection(pos, selector);\n\n      if (shape) {\n        return shape;\n      }\n    }\n\n    return null;\n  };\n\n  Stage.prototype._resizeDOM = function () {\n    var width = this.width();\n    var height = this.height();\n\n    if (this.content) {\n      this.content.style.width = width + PX;\n      this.content.style.height = height + PX;\n    }\n\n    this.bufferCanvas.setSize(width, height);\n    this.bufferHitCanvas.setSize(width, height);\n    this.children.each(function (layer) {\n      layer.setSize({\n        width: width,\n        height: height\n      });\n      layer.draw();\n    });\n  };\n\n  Stage.prototype.add = function (layer) {\n    if (arguments.length > 1) {\n      for (var i = 0; i < arguments.length; i++) {\n        this.add(arguments[i]);\n      }\n\n      return this;\n    }\n\n    _super.prototype.add.call(this, layer);\n\n    var length = this.children.length;\n\n    if (length > MAX_LAYERS_NUMBER) {\n      Util_1.Util.warn('The stage has ' + length + ' layers. Recommended maximum number of layers is 3-5. Adding more layers into the stage may drop the performance. Rethink your tree structure, you can use Konva.Group.');\n    }\n\n    layer.setSize({\n      width: this.width(),\n      height: this.height()\n    });\n    layer.draw();\n\n    if (Global_1.Konva.isBrowser) {\n      this.content.appendChild(layer.canvas._canvas);\n    }\n\n    return this;\n  };\n\n  Stage.prototype.getParent = function () {\n    return null;\n  };\n\n  Stage.prototype.getLayer = function () {\n    return null;\n  };\n\n  Stage.prototype.hasPointerCapture = function (pointerId) {\n    return PointerEvents.hasPointerCapture(pointerId, this);\n  };\n\n  Stage.prototype.setPointerCapture = function (pointerId) {\n    PointerEvents.setPointerCapture(pointerId, this);\n  };\n\n  Stage.prototype.releaseCapture = function (pointerId) {\n    PointerEvents.releaseCapture(pointerId, this);\n  };\n\n  Stage.prototype.getLayers = function () {\n    return this.getChildren();\n  };\n\n  Stage.prototype._bindContentEvents = function () {\n    if (!Global_1.Konva.isBrowser) {\n      return;\n    }\n\n    for (var n = 0; n < eventsLength; n++) {\n      addEvent(this, EVENTS[n]);\n    }\n  };\n\n  Stage.prototype._mouseenter = function (evt) {\n    this.setPointersPositions(evt);\n\n    this._fire(MOUSEENTER, {\n      evt: evt,\n      target: this,\n      currentTarget: this\n    });\n  };\n\n  Stage.prototype._mouseover = function (evt) {\n    this.setPointersPositions(evt);\n\n    this._fire(CONTENT_MOUSEOVER, {\n      evt: evt\n    });\n\n    this._fire(MOUSEOVER, {\n      evt: evt,\n      target: this,\n      currentTarget: this\n    });\n  };\n\n  Stage.prototype._mouseout = function (evt) {\n    var _a;\n\n    this.setPointersPositions(evt);\n    var targetShape = ((_a = this.targetShape) === null || _a === void 0 ? void 0 : _a.getStage()) ? this.targetShape : null;\n    var eventsEnabled = !DragAndDrop_1.DD.isDragging || Global_1.Konva.hitOnDragEnabled;\n\n    if (targetShape && eventsEnabled) {\n      targetShape._fireAndBubble(MOUSEOUT, {\n        evt: evt\n      });\n\n      targetShape._fireAndBubble(MOUSELEAVE, {\n        evt: evt\n      });\n\n      this._fire(MOUSELEAVE, {\n        evt: evt,\n        target: this,\n        currentTarget: this\n      });\n\n      this.targetShape = null;\n    } else if (eventsEnabled) {\n      this._fire(MOUSELEAVE, {\n        evt: evt,\n        target: this,\n        currentTarget: this\n      });\n\n      this._fire(MOUSEOUT, {\n        evt: evt,\n        target: this,\n        currentTarget: this\n      });\n    }\n\n    this.pointerPos = undefined;\n    this._pointerPositions = [];\n\n    this._fire(CONTENT_MOUSEOUT, {\n      evt: evt\n    });\n  };\n\n  Stage.prototype._mousemove = function (evt) {\n    var _a;\n\n    if (Global_1.Konva.UA.ieMobile) {\n      return this._touchmove(evt);\n    }\n\n    this.setPointersPositions(evt);\n\n    var pointerId = Util_1.Util._getFirstPointerId(evt);\n\n    var shape;\n    var targetShape = ((_a = this.targetShape) === null || _a === void 0 ? void 0 : _a.getStage()) ? this.targetShape : null;\n    var eventsEnabled = !DragAndDrop_1.DD.isDragging || Global_1.Konva.hitOnDragEnabled;\n\n    if (eventsEnabled) {\n      shape = this.getIntersection(this.getPointerPosition());\n\n      if (shape && shape.isListening()) {\n        var differentTarget = targetShape !== shape;\n\n        if (eventsEnabled && differentTarget) {\n          if (targetShape) {\n            targetShape._fireAndBubble(MOUSEOUT, {\n              evt: evt,\n              pointerId: pointerId\n            }, shape);\n\n            targetShape._fireAndBubble(MOUSELEAVE, {\n              evt: evt,\n              pointerId: pointerId\n            }, shape);\n          }\n\n          shape._fireAndBubble(MOUSEOVER, {\n            evt: evt,\n            pointerId: pointerId\n          }, targetShape);\n\n          shape._fireAndBubble(MOUSEENTER, {\n            evt: evt,\n            pointerId: pointerId\n          }, targetShape);\n\n          shape._fireAndBubble(MOUSEMOVE, {\n            evt: evt,\n            pointerId: pointerId\n          });\n\n          this.targetShape = shape;\n        } else {\n          shape._fireAndBubble(MOUSEMOVE, {\n            evt: evt,\n            pointerId: pointerId\n          });\n        }\n      } else {\n        if (targetShape && eventsEnabled) {\n          targetShape._fireAndBubble(MOUSEOUT, {\n            evt: evt,\n            pointerId: pointerId\n          });\n\n          targetShape._fireAndBubble(MOUSELEAVE, {\n            evt: evt,\n            pointerId: pointerId\n          });\n\n          this._fire(MOUSEOVER, {\n            evt: evt,\n            target: this,\n            currentTarget: this,\n            pointerId: pointerId\n          });\n\n          this.targetShape = null;\n        }\n\n        this._fire(MOUSEMOVE, {\n          evt: evt,\n          target: this,\n          currentTarget: this,\n          pointerId: pointerId\n        });\n      }\n\n      this._fire(CONTENT_MOUSEMOVE, {\n        evt: evt\n      });\n    }\n\n    if (evt.cancelable) {\n      evt.preventDefault();\n    }\n  };\n\n  Stage.prototype._mousedown = function (evt) {\n    if (Global_1.Konva.UA.ieMobile) {\n      return this._touchstart(evt);\n    }\n\n    this.setPointersPositions(evt);\n\n    var pointerId = Util_1.Util._getFirstPointerId(evt);\n\n    var shape = this.getIntersection(this.getPointerPosition());\n    DragAndDrop_1.DD.justDragged = false;\n    Global_1.Konva.listenClickTap = true;\n\n    if (shape && shape.isListening()) {\n      this.clickStartShape = shape;\n\n      shape._fireAndBubble(MOUSEDOWN, {\n        evt: evt,\n        pointerId: pointerId\n      });\n    } else {\n      this._fire(MOUSEDOWN, {\n        evt: evt,\n        target: this,\n        currentTarget: this,\n        pointerId: pointerId\n      });\n    }\n\n    this._fire(CONTENT_MOUSEDOWN, {\n      evt: evt\n    });\n  };\n\n  Stage.prototype._mouseup = function (evt) {\n    if (Global_1.Konva.UA.ieMobile) {\n      return this._touchend(evt);\n    }\n\n    this.setPointersPositions(evt);\n\n    var pointerId = Util_1.Util._getFirstPointerId(evt);\n\n    var shape = this.getIntersection(this.getPointerPosition()),\n        clickStartShape = this.clickStartShape,\n        clickEndShape = this.clickEndShape,\n        fireDblClick = false;\n\n    if (Global_1.Konva.inDblClickWindow) {\n      fireDblClick = true;\n      clearTimeout(this.dblTimeout);\n    } else if (!DragAndDrop_1.DD.justDragged) {\n      Global_1.Konva.inDblClickWindow = true;\n      clearTimeout(this.dblTimeout);\n    }\n\n    this.dblTimeout = setTimeout(function () {\n      Global_1.Konva.inDblClickWindow = false;\n    }, Global_1.Konva.dblClickWindow);\n\n    if (shape && shape.isListening()) {\n      this.clickEndShape = shape;\n\n      shape._fireAndBubble(MOUSEUP, {\n        evt: evt,\n        pointerId: pointerId\n      });\n\n      if (Global_1.Konva.listenClickTap && clickStartShape && clickStartShape._id === shape._id) {\n        shape._fireAndBubble(CLICK, {\n          evt: evt,\n          pointerId: pointerId\n        });\n\n        if (fireDblClick && clickEndShape && clickEndShape === shape) {\n          shape._fireAndBubble(DBL_CLICK, {\n            evt: evt,\n            pointerId: pointerId\n          });\n        }\n      }\n    } else {\n      this.clickEndShape = null;\n\n      this._fire(MOUSEUP, {\n        evt: evt,\n        target: this,\n        currentTarget: this,\n        pointerId: pointerId\n      });\n\n      if (Global_1.Konva.listenClickTap) {\n        this._fire(CLICK, {\n          evt: evt,\n          target: this,\n          currentTarget: this,\n          pointerId: pointerId\n        });\n      }\n\n      if (fireDblClick) {\n        this._fire(DBL_CLICK, {\n          evt: evt,\n          target: this,\n          currentTarget: this,\n          pointerId: pointerId\n        });\n      }\n    }\n\n    this._fire(CONTENT_MOUSEUP, {\n      evt: evt\n    });\n\n    if (Global_1.Konva.listenClickTap) {\n      this._fire(CONTENT_CLICK, {\n        evt: evt\n      });\n\n      if (fireDblClick) {\n        this._fire(CONTENT_DBL_CLICK, {\n          evt: evt\n        });\n      }\n    }\n\n    Global_1.Konva.listenClickTap = false;\n\n    if (evt.cancelable) {\n      evt.preventDefault();\n    }\n  };\n\n  Stage.prototype._contextmenu = function (evt) {\n    this.setPointersPositions(evt);\n    var shape = this.getIntersection(this.getPointerPosition());\n\n    if (shape && shape.isListening()) {\n      shape._fireAndBubble(CONTEXTMENU, {\n        evt: evt\n      });\n    } else {\n      this._fire(CONTEXTMENU, {\n        evt: evt,\n        target: this,\n        currentTarget: this\n      });\n    }\n\n    this._fire(CONTENT_CONTEXTMENU, {\n      evt: evt\n    });\n  };\n\n  Stage.prototype._touchstart = function (evt) {\n    var _this = this;\n\n    this.setPointersPositions(evt);\n    var triggeredOnShape = false;\n\n    this._changedPointerPositions.forEach(function (pos) {\n      var shape = _this.getIntersection(pos);\n\n      Global_1.Konva.listenClickTap = true;\n      DragAndDrop_1.DD.justDragged = false;\n      var hasShape = shape && shape.isListening();\n\n      if (!hasShape) {\n        return;\n      }\n\n      if (Global_1.Konva.captureTouchEventsEnabled) {\n        shape.setPointerCapture(pos.id);\n      }\n\n      _this.tapStartShape = shape;\n\n      shape._fireAndBubble(TOUCHSTART, {\n        evt: evt,\n        pointerId: pos.id\n      }, _this);\n\n      triggeredOnShape = true;\n\n      if (shape.isListening() && shape.preventDefault() && evt.cancelable) {\n        evt.preventDefault();\n      }\n    });\n\n    if (!triggeredOnShape) {\n      this._fire(TOUCHSTART, {\n        evt: evt,\n        target: this,\n        currentTarget: this,\n        pointerId: this._changedPointerPositions[0].id\n      });\n    }\n\n    this._fire(CONTENT_TOUCHSTART, {\n      evt: evt\n    });\n  };\n\n  Stage.prototype._touchmove = function (evt) {\n    var _this = this;\n\n    this.setPointersPositions(evt);\n    var eventsEnabled = !DragAndDrop_1.DD.isDragging || Global_1.Konva.hitOnDragEnabled;\n\n    if (eventsEnabled) {\n      var triggeredOnShape = false;\n      var processedShapesIds = {};\n\n      this._changedPointerPositions.forEach(function (pos) {\n        var shape = PointerEvents.getCapturedShape(pos.id) || _this.getIntersection(pos);\n\n        var hasShape = shape && shape.isListening();\n\n        if (!hasShape) {\n          return;\n        }\n\n        if (processedShapesIds[shape._id]) {\n          return;\n        }\n\n        processedShapesIds[shape._id] = true;\n\n        shape._fireAndBubble(TOUCHMOVE, {\n          evt: evt,\n          pointerId: pos.id\n        });\n\n        triggeredOnShape = true;\n\n        if (shape.isListening() && shape.preventDefault() && evt.cancelable) {\n          evt.preventDefault();\n        }\n      });\n\n      if (!triggeredOnShape) {\n        this._fire(TOUCHMOVE, {\n          evt: evt,\n          target: this,\n          currentTarget: this,\n          pointerId: this._changedPointerPositions[0].id\n        });\n      }\n\n      this._fire(CONTENT_TOUCHMOVE, {\n        evt: evt\n      });\n    }\n\n    if (DragAndDrop_1.DD.isDragging && DragAndDrop_1.DD.node.preventDefault() && evt.cancelable) {\n      evt.preventDefault();\n    }\n  };\n\n  Stage.prototype._touchend = function (evt) {\n    var _this = this;\n\n    this.setPointersPositions(evt);\n    var tapEndShape = this.tapEndShape,\n        fireDblClick = false;\n\n    if (Global_1.Konva.inDblClickWindow) {\n      fireDblClick = true;\n      clearTimeout(this.dblTimeout);\n    } else if (!DragAndDrop_1.DD.justDragged) {\n      Global_1.Konva.inDblClickWindow = true;\n      clearTimeout(this.dblTimeout);\n    }\n\n    this.dblTimeout = setTimeout(function () {\n      Global_1.Konva.inDblClickWindow = false;\n    }, Global_1.Konva.dblClickWindow);\n    var triggeredOnShape = false;\n    var processedShapesIds = {};\n    var tapTriggered = false;\n    var dblTapTriggered = false;\n\n    this._changedPointerPositions.forEach(function (pos) {\n      var shape = PointerEvents.getCapturedShape(pos.id) || _this.getIntersection(pos);\n\n      if (shape) {\n        shape.releaseCapture(pos.id);\n      }\n\n      var hasShape = shape && shape.isListening();\n\n      if (!hasShape) {\n        return;\n      }\n\n      if (processedShapesIds[shape._id]) {\n        return;\n      }\n\n      processedShapesIds[shape._id] = true;\n      _this.tapEndShape = shape;\n\n      shape._fireAndBubble(TOUCHEND, {\n        evt: evt,\n        pointerId: pos.id\n      });\n\n      triggeredOnShape = true;\n\n      if (Global_1.Konva.listenClickTap && shape === _this.tapStartShape) {\n        tapTriggered = true;\n\n        shape._fireAndBubble(TAP, {\n          evt: evt,\n          pointerId: pos.id\n        });\n\n        if (fireDblClick && tapEndShape && tapEndShape === shape) {\n          dblTapTriggered = true;\n\n          shape._fireAndBubble(DBL_TAP, {\n            evt: evt,\n            pointerId: pos.id\n          });\n        }\n      }\n\n      if (shape.isListening() && shape.preventDefault() && evt.cancelable) {\n        evt.preventDefault();\n      }\n    });\n\n    if (!triggeredOnShape) {\n      this._fire(TOUCHEND, {\n        evt: evt,\n        target: this,\n        currentTarget: this,\n        pointerId: this._changedPointerPositions[0].id\n      });\n    }\n\n    if (Global_1.Konva.listenClickTap && !tapTriggered) {\n      this.tapEndShape = null;\n\n      this._fire(TAP, {\n        evt: evt,\n        target: this,\n        currentTarget: this,\n        pointerId: this._changedPointerPositions[0].id\n      });\n    }\n\n    if (fireDblClick && !dblTapTriggered) {\n      this._fire(DBL_TAP, {\n        evt: evt,\n        target: this,\n        currentTarget: this,\n        pointerId: this._changedPointerPositions[0].id\n      });\n    }\n\n    this._fire(CONTENT_TOUCHEND, {\n      evt: evt\n    });\n\n    if (Global_1.Konva.listenClickTap) {\n      this._fire(CONTENT_TAP, {\n        evt: evt\n      });\n\n      if (fireDblClick) {\n        this._fire(CONTENT_DBL_TAP, {\n          evt: evt\n        });\n      }\n    }\n\n    if (this.preventDefault() && evt.cancelable) {\n      evt.preventDefault();\n    }\n\n    Global_1.Konva.listenClickTap = false;\n  };\n\n  Stage.prototype._wheel = function (evt) {\n    this.setPointersPositions(evt);\n    var shape = this.getIntersection(this.getPointerPosition());\n\n    if (shape && shape.isListening()) {\n      shape._fireAndBubble(WHEEL, {\n        evt: evt\n      });\n    } else {\n      this._fire(WHEEL, {\n        evt: evt,\n        target: this,\n        currentTarget: this\n      });\n    }\n\n    this._fire(CONTENT_WHEEL, {\n      evt: evt\n    });\n  };\n\n  Stage.prototype._pointerdown = function (evt) {\n    if (!Global_1.Konva._pointerEventsEnabled) {\n      return;\n    }\n\n    this.setPointersPositions(evt);\n    var shape = PointerEvents.getCapturedShape(evt.pointerId) || this.getIntersection(this.getPointerPosition());\n\n    if (shape) {\n      shape._fireAndBubble(POINTERDOWN, PointerEvents.createEvent(evt));\n    }\n  };\n\n  Stage.prototype._pointermove = function (evt) {\n    if (!Global_1.Konva._pointerEventsEnabled) {\n      return;\n    }\n\n    this.setPointersPositions(evt);\n    var shape = PointerEvents.getCapturedShape(evt.pointerId) || this.getIntersection(this.getPointerPosition());\n\n    if (shape) {\n      shape._fireAndBubble(POINTERMOVE, PointerEvents.createEvent(evt));\n    }\n  };\n\n  Stage.prototype._pointerup = function (evt) {\n    if (!Global_1.Konva._pointerEventsEnabled) {\n      return;\n    }\n\n    this.setPointersPositions(evt);\n    var shape = PointerEvents.getCapturedShape(evt.pointerId) || this.getIntersection(this.getPointerPosition());\n\n    if (shape) {\n      shape._fireAndBubble(POINTERUP, PointerEvents.createEvent(evt));\n    }\n\n    PointerEvents.releaseCapture(evt.pointerId);\n  };\n\n  Stage.prototype._pointercancel = function (evt) {\n    if (!Global_1.Konva._pointerEventsEnabled) {\n      return;\n    }\n\n    this.setPointersPositions(evt);\n    var shape = PointerEvents.getCapturedShape(evt.pointerId) || this.getIntersection(this.getPointerPosition());\n\n    if (shape) {\n      shape._fireAndBubble(POINTERUP, PointerEvents.createEvent(evt));\n    }\n\n    PointerEvents.releaseCapture(evt.pointerId);\n  };\n\n  Stage.prototype._lostpointercapture = function (evt) {\n    PointerEvents.releaseCapture(evt.pointerId);\n  };\n\n  Stage.prototype.setPointersPositions = function (evt) {\n    var _this = this;\n\n    var contentPosition = this._getContentPosition(),\n        x = null,\n        y = null;\n\n    evt = evt ? evt : window.event;\n\n    if (evt.touches !== undefined) {\n      this._pointerPositions = [];\n      this._changedPointerPositions = [];\n      Util_1.Collection.prototype.each.call(evt.touches, function (touch) {\n        _this._pointerPositions.push({\n          id: touch.identifier,\n          x: (touch.clientX - contentPosition.left) / contentPosition.scaleX,\n          y: (touch.clientY - contentPosition.top) / contentPosition.scaleY\n        });\n      });\n      Util_1.Collection.prototype.each.call(evt.changedTouches || evt.touches, function (touch) {\n        _this._changedPointerPositions.push({\n          id: touch.identifier,\n          x: (touch.clientX - contentPosition.left) / contentPosition.scaleX,\n          y: (touch.clientY - contentPosition.top) / contentPosition.scaleY\n        });\n      });\n    } else {\n      x = (evt.clientX - contentPosition.left) / contentPosition.scaleX;\n      y = (evt.clientY - contentPosition.top) / contentPosition.scaleY;\n      this.pointerPos = {\n        x: x,\n        y: y\n      };\n      this._pointerPositions = [{\n        x: x,\n        y: y,\n        id: Util_1.Util._getFirstPointerId(evt)\n      }];\n      this._changedPointerPositions = [{\n        x: x,\n        y: y,\n        id: Util_1.Util._getFirstPointerId(evt)\n      }];\n    }\n  };\n\n  Stage.prototype._setPointerPosition = function (evt) {\n    Util_1.Util.warn('Method _setPointerPosition is deprecated. Use \"stage.setPointersPositions(event)\" instead.');\n    this.setPointersPositions(evt);\n  };\n\n  Stage.prototype._getContentPosition = function () {\n    if (!this.content || !this.content.getBoundingClientRect) {\n      return {\n        top: 0,\n        left: 0,\n        scaleX: 1,\n        scaleY: 1\n      };\n    }\n\n    var rect = this.content.getBoundingClientRect();\n    return {\n      top: rect.top,\n      left: rect.left,\n      scaleX: rect.width / this.content.clientWidth || 1,\n      scaleY: rect.height / this.content.clientHeight || 1\n    };\n  };\n\n  Stage.prototype._buildDOM = function () {\n    this.bufferCanvas = new Canvas_1.SceneCanvas({\n      width: this.width(),\n      height: this.height()\n    });\n    this.bufferHitCanvas = new Canvas_1.HitCanvas({\n      pixelRatio: 1,\n      width: this.width(),\n      height: this.height()\n    });\n\n    if (!Global_1.Konva.isBrowser) {\n      return;\n    }\n\n    var container = this.container();\n\n    if (!container) {\n      throw 'Stage has no container. A container is required.';\n    }\n\n    container.innerHTML = EMPTY_STRING;\n    this.content = document.createElement('div');\n    this.content.style.position = RELATIVE;\n    this.content.style.userSelect = 'none';\n    this.content.className = KONVA_CONTENT;\n    this.content.setAttribute('role', 'presentation');\n    container.appendChild(this.content);\n\n    this._resizeDOM();\n  };\n\n  Stage.prototype.cache = function () {\n    Util_1.Util.warn('Cache function is not allowed for stage. You may use cache only for layers, groups and shapes.');\n    return this;\n  };\n\n  Stage.prototype.clearCache = function () {\n    return this;\n  };\n\n  Stage.prototype.batchDraw = function () {\n    this.children.each(function (layer) {\n      layer.batchDraw();\n    });\n    return this;\n  };\n\n  return Stage;\n}(Container_1.Container);\n\nexports.Stage = Stage;\nStage.prototype.nodeType = STAGE;\n\nGlobal_2._registerNode(Stage);\n\nFactory_1.Factory.addGetterSetter(Stage, 'container');","map":{"version":3,"sources":["/home/jun/foodbank/node_modules/konva/lib/Stage.js"],"names":["__extends","extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__","constructor","prototype","create","defineProperty","exports","value","Util_1","require","Factory_1","Container_1","Global_1","Canvas_1","DragAndDrop_1","Global_2","PointerEvents","STAGE","STRING","PX","MOUSEOUT","MOUSELEAVE","MOUSEOVER","MOUSEENTER","MOUSEMOVE","MOUSEDOWN","MOUSEUP","POINTERMOVE","POINTERDOWN","POINTERUP","POINTERCANCEL","LOSTPOINTERCAPTURE","CONTEXTMENU","CLICK","DBL_CLICK","TOUCHSTART","TOUCHEND","TAP","DBL_TAP","TOUCHMOVE","WHEEL","CONTENT_MOUSEOUT","CONTENT_MOUSEOVER","CONTENT_MOUSEMOVE","CONTENT_MOUSEDOWN","CONTENT_MOUSEUP","CONTENT_CONTEXTMENU","CONTENT_CLICK","CONTENT_DBL_CLICK","CONTENT_TOUCHSTART","CONTENT_TOUCHEND","CONTENT_DBL_TAP","CONTENT_TAP","CONTENT_TOUCHMOVE","CONTENT_POINTERMOVE","CONTENT_POINTERDOWN","CONTENT_POINTERUP","CONTENT_WHEEL","RELATIVE","KONVA_CONTENT","SPACE","UNDERSCORE","CONTAINER","MAX_LAYERS_NUMBER","EMPTY_STRING","EVENTS","eventsLength","length","addEvent","ctx","eventName","content","addEventListener","evt","NO_POINTERS_MESSAGE","stages","checkNoClip","attrs","clipFunc","clipWidth","clipHeight","Util","warn","Stage","_super","config","_this","call","_pointerPositions","_changedPointerPositions","_buildDOM","_bindContentEvents","push","on","_resizeDOM","_checkVisibility","_validateAdd","child","isLayer","getType","isFastLayer","valid","throw","style","visible","display","setContainer","container","charAt","className","slice","document","getElementsByClassName","id","getElementById","_setAttr","parentElement","removeChild","appendChild","shouldDrawHit","clear","layers","children","len","n","clone","obj","createElement","Container","destroy","_isInDocument","index","indexOf","splice","getPointerPosition","pos","x","y","_getPointerById","find","getPointersPositions","getStage","getContent","_toKonvaCanvas","width","height","canvas","SceneCanvas","pixelRatio","_context","getContext","translate","each","layer","isVisible","layerCanvas","drawImage","_canvas","getWidth","getPixelRatio","getHeight","getIntersection","selector","end","shape","bufferCanvas","setSize","bufferHitCanvas","draw","add","arguments","i","Konva","isBrowser","getParent","getLayer","hasPointerCapture","pointerId","setPointerCapture","releaseCapture","getLayers","getChildren","_mouseenter","setPointersPositions","_fire","target","currentTarget","_mouseover","_mouseout","_a","targetShape","eventsEnabled","DD","isDragging","hitOnDragEnabled","_fireAndBubble","pointerPos","undefined","_mousemove","UA","ieMobile","_touchmove","_getFirstPointerId","isListening","differentTarget","cancelable","preventDefault","_mousedown","_touchstart","justDragged","listenClickTap","clickStartShape","_mouseup","_touchend","clickEndShape","fireDblClick","inDblClickWindow","clearTimeout","dblTimeout","setTimeout","dblClickWindow","_id","_contextmenu","triggeredOnShape","forEach","hasShape","captureTouchEventsEnabled","tapStartShape","processedShapesIds","getCapturedShape","node","tapEndShape","tapTriggered","dblTapTriggered","_wheel","_pointerdown","_pointerEventsEnabled","createEvent","_pointermove","_pointerup","_pointercancel","_lostpointercapture","contentPosition","_getContentPosition","window","event","touches","Collection","touch","identifier","clientX","left","scaleX","clientY","top","scaleY","changedTouches","_setPointerPosition","getBoundingClientRect","rect","clientWidth","clientHeight","HitCanvas","innerHTML","position","userSelect","setAttribute","cache","clearCache","batchDraw","nodeType","_registerNode","Factory","addGetterSetter"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar Util_1 = require(\"./Util\");\nvar Factory_1 = require(\"./Factory\");\nvar Container_1 = require(\"./Container\");\nvar Global_1 = require(\"./Global\");\nvar Canvas_1 = require(\"./Canvas\");\nvar DragAndDrop_1 = require(\"./DragAndDrop\");\nvar Global_2 = require(\"./Global\");\nvar PointerEvents = require(\"./PointerEvents\");\nvar STAGE = 'Stage', STRING = 'string', PX = 'px', MOUSEOUT = 'mouseout', MOUSELEAVE = 'mouseleave', MOUSEOVER = 'mouseover', MOUSEENTER = 'mouseenter', MOUSEMOVE = 'mousemove', MOUSEDOWN = 'mousedown', MOUSEUP = 'mouseup', POINTERMOVE = 'pointermove', POINTERDOWN = 'pointerdown', POINTERUP = 'pointerup', POINTERCANCEL = 'pointercancel', LOSTPOINTERCAPTURE = 'lostpointercapture', CONTEXTMENU = 'contextmenu', CLICK = 'click', DBL_CLICK = 'dblclick', TOUCHSTART = 'touchstart', TOUCHEND = 'touchend', TAP = 'tap', DBL_TAP = 'dbltap', TOUCHMOVE = 'touchmove', WHEEL = 'wheel', CONTENT_MOUSEOUT = 'contentMouseout', CONTENT_MOUSEOVER = 'contentMouseover', CONTENT_MOUSEMOVE = 'contentMousemove', CONTENT_MOUSEDOWN = 'contentMousedown', CONTENT_MOUSEUP = 'contentMouseup', CONTENT_CONTEXTMENU = 'contentContextmenu', CONTENT_CLICK = 'contentClick', CONTENT_DBL_CLICK = 'contentDblclick', CONTENT_TOUCHSTART = 'contentTouchstart', CONTENT_TOUCHEND = 'contentTouchend', CONTENT_DBL_TAP = 'contentDbltap', CONTENT_TAP = 'contentTap', CONTENT_TOUCHMOVE = 'contentTouchmove', CONTENT_POINTERMOVE = 'contentPointermove', CONTENT_POINTERDOWN = 'contentPointerdown', CONTENT_POINTERUP = 'contentPointerup', CONTENT_WHEEL = 'contentWheel', RELATIVE = 'relative', KONVA_CONTENT = 'konvajs-content', SPACE = ' ', UNDERSCORE = '_', CONTAINER = 'container', MAX_LAYERS_NUMBER = 5, EMPTY_STRING = '', EVENTS = [\n    MOUSEENTER,\n    MOUSEDOWN,\n    MOUSEMOVE,\n    MOUSEUP,\n    MOUSEOUT,\n    TOUCHSTART,\n    TOUCHMOVE,\n    TOUCHEND,\n    MOUSEOVER,\n    WHEEL,\n    CONTEXTMENU,\n    POINTERDOWN,\n    POINTERMOVE,\n    POINTERUP,\n    POINTERCANCEL,\n    LOSTPOINTERCAPTURE,\n], eventsLength = EVENTS.length;\nfunction addEvent(ctx, eventName) {\n    ctx.content.addEventListener(eventName, function (evt) {\n        ctx[UNDERSCORE + eventName](evt);\n    }, false);\n}\nvar NO_POINTERS_MESSAGE = \"Pointer position is missing and not registered by the stage. Looks like it is outside of the stage container. You can set it manually from event: stage.setPointersPositions(event);\";\nexports.stages = [];\nfunction checkNoClip(attrs) {\n    if (attrs === void 0) { attrs = {}; }\n    if (attrs.clipFunc || attrs.clipWidth || attrs.clipHeight) {\n        Util_1.Util.warn('Stage does not support clipping. Please use clip for Layers or Groups.');\n    }\n    return attrs;\n}\nvar Stage = (function (_super) {\n    __extends(Stage, _super);\n    function Stage(config) {\n        var _this = _super.call(this, checkNoClip(config)) || this;\n        _this._pointerPositions = [];\n        _this._changedPointerPositions = [];\n        _this._buildDOM();\n        _this._bindContentEvents();\n        exports.stages.push(_this);\n        _this.on('widthChange.konva heightChange.konva', _this._resizeDOM);\n        _this.on('visibleChange.konva', _this._checkVisibility);\n        _this.on('clipWidthChange.konva clipHeightChange.konva clipFuncChange.konva', function () {\n            checkNoClip(_this.attrs);\n        });\n        _this._checkVisibility();\n        return _this;\n    }\n    Stage.prototype._validateAdd = function (child) {\n        var isLayer = child.getType() === 'Layer';\n        var isFastLayer = child.getType() === 'FastLayer';\n        var valid = isLayer || isFastLayer;\n        if (!valid) {\n            Util_1.Util.throw('You may only add layers to the stage.');\n        }\n    };\n    Stage.prototype._checkVisibility = function () {\n        if (!this.content) {\n            return;\n        }\n        var style = this.visible() ? '' : 'none';\n        this.content.style.display = style;\n    };\n    Stage.prototype.setContainer = function (container) {\n        if (typeof container === STRING) {\n            if (container.charAt(0) === '.') {\n                var className = container.slice(1);\n                container = document.getElementsByClassName(className)[0];\n            }\n            else {\n                var id;\n                if (container.charAt(0) !== '#') {\n                    id = container;\n                }\n                else {\n                    id = container.slice(1);\n                }\n                container = document.getElementById(id);\n            }\n            if (!container) {\n                throw 'Can not find container in document with id ' + id;\n            }\n        }\n        this._setAttr(CONTAINER, container);\n        if (this.content) {\n            if (this.content.parentElement) {\n                this.content.parentElement.removeChild(this.content);\n            }\n            container.appendChild(this.content);\n        }\n        return this;\n    };\n    Stage.prototype.shouldDrawHit = function () {\n        return true;\n    };\n    Stage.prototype.clear = function () {\n        var layers = this.children, len = layers.length, n;\n        for (n = 0; n < len; n++) {\n            layers[n].clear();\n        }\n        return this;\n    };\n    Stage.prototype.clone = function (obj) {\n        if (!obj) {\n            obj = {};\n        }\n        obj.container = document.createElement('div');\n        return Container_1.Container.prototype.clone.call(this, obj);\n    };\n    Stage.prototype.destroy = function () {\n        _super.prototype.destroy.call(this);\n        var content = this.content;\n        if (content && Util_1.Util._isInDocument(content)) {\n            this.container().removeChild(content);\n        }\n        var index = exports.stages.indexOf(this);\n        if (index > -1) {\n            exports.stages.splice(index, 1);\n        }\n        return this;\n    };\n    Stage.prototype.getPointerPosition = function () {\n        var pos = this._pointerPositions[0] || this._changedPointerPositions[0];\n        if (!pos) {\n            Util_1.Util.warn(NO_POINTERS_MESSAGE);\n            return null;\n        }\n        return {\n            x: pos.x,\n            y: pos.y,\n        };\n    };\n    Stage.prototype._getPointerById = function (id) {\n        return this._pointerPositions.find(function (p) { return p.id === id; });\n    };\n    Stage.prototype.getPointersPositions = function () {\n        return this._pointerPositions;\n    };\n    Stage.prototype.getStage = function () {\n        return this;\n    };\n    Stage.prototype.getContent = function () {\n        return this.content;\n    };\n    Stage.prototype._toKonvaCanvas = function (config) {\n        config = config || {};\n        config.x = config.x || 0;\n        config.y = config.y || 0;\n        config.width = config.width || this.width();\n        config.height = config.height || this.height();\n        var canvas = new Canvas_1.SceneCanvas({\n            width: config.width,\n            height: config.height,\n            pixelRatio: config.pixelRatio || 1,\n        });\n        var _context = canvas.getContext()._context;\n        var layers = this.children;\n        if (config.x || config.y) {\n            _context.translate(-1 * config.x, -1 * config.y);\n        }\n        layers.each(function (layer) {\n            if (!layer.isVisible()) {\n                return;\n            }\n            var layerCanvas = layer._toKonvaCanvas(config);\n            _context.drawImage(layerCanvas._canvas, config.x, config.y, layerCanvas.getWidth() / layerCanvas.getPixelRatio(), layerCanvas.getHeight() / layerCanvas.getPixelRatio());\n        });\n        return canvas;\n    };\n    Stage.prototype.getIntersection = function (pos, selector) {\n        if (!pos) {\n            return null;\n        }\n        var layers = this.children, len = layers.length, end = len - 1, n, shape;\n        for (n = end; n >= 0; n--) {\n            shape = layers[n].getIntersection(pos, selector);\n            if (shape) {\n                return shape;\n            }\n        }\n        return null;\n    };\n    Stage.prototype._resizeDOM = function () {\n        var width = this.width();\n        var height = this.height();\n        if (this.content) {\n            this.content.style.width = width + PX;\n            this.content.style.height = height + PX;\n        }\n        this.bufferCanvas.setSize(width, height);\n        this.bufferHitCanvas.setSize(width, height);\n        this.children.each(function (layer) {\n            layer.setSize({ width: width, height: height });\n            layer.draw();\n        });\n    };\n    Stage.prototype.add = function (layer) {\n        if (arguments.length > 1) {\n            for (var i = 0; i < arguments.length; i++) {\n                this.add(arguments[i]);\n            }\n            return this;\n        }\n        _super.prototype.add.call(this, layer);\n        var length = this.children.length;\n        if (length > MAX_LAYERS_NUMBER) {\n            Util_1.Util.warn('The stage has ' +\n                length +\n                ' layers. Recommended maximum number of layers is 3-5. Adding more layers into the stage may drop the performance. Rethink your tree structure, you can use Konva.Group.');\n        }\n        layer.setSize({ width: this.width(), height: this.height() });\n        layer.draw();\n        if (Global_1.Konva.isBrowser) {\n            this.content.appendChild(layer.canvas._canvas);\n        }\n        return this;\n    };\n    Stage.prototype.getParent = function () {\n        return null;\n    };\n    Stage.prototype.getLayer = function () {\n        return null;\n    };\n    Stage.prototype.hasPointerCapture = function (pointerId) {\n        return PointerEvents.hasPointerCapture(pointerId, this);\n    };\n    Stage.prototype.setPointerCapture = function (pointerId) {\n        PointerEvents.setPointerCapture(pointerId, this);\n    };\n    Stage.prototype.releaseCapture = function (pointerId) {\n        PointerEvents.releaseCapture(pointerId, this);\n    };\n    Stage.prototype.getLayers = function () {\n        return this.getChildren();\n    };\n    Stage.prototype._bindContentEvents = function () {\n        if (!Global_1.Konva.isBrowser) {\n            return;\n        }\n        for (var n = 0; n < eventsLength; n++) {\n            addEvent(this, EVENTS[n]);\n        }\n    };\n    Stage.prototype._mouseenter = function (evt) {\n        this.setPointersPositions(evt);\n        this._fire(MOUSEENTER, { evt: evt, target: this, currentTarget: this });\n    };\n    Stage.prototype._mouseover = function (evt) {\n        this.setPointersPositions(evt);\n        this._fire(CONTENT_MOUSEOVER, { evt: evt });\n        this._fire(MOUSEOVER, { evt: evt, target: this, currentTarget: this });\n    };\n    Stage.prototype._mouseout = function (evt) {\n        var _a;\n        this.setPointersPositions(evt);\n        var targetShape = ((_a = this.targetShape) === null || _a === void 0 ? void 0 : _a.getStage()) ? this.targetShape : null;\n        var eventsEnabled = !DragAndDrop_1.DD.isDragging || Global_1.Konva.hitOnDragEnabled;\n        if (targetShape && eventsEnabled) {\n            targetShape._fireAndBubble(MOUSEOUT, { evt: evt });\n            targetShape._fireAndBubble(MOUSELEAVE, { evt: evt });\n            this._fire(MOUSELEAVE, { evt: evt, target: this, currentTarget: this });\n            this.targetShape = null;\n        }\n        else if (eventsEnabled) {\n            this._fire(MOUSELEAVE, {\n                evt: evt,\n                target: this,\n                currentTarget: this,\n            });\n            this._fire(MOUSEOUT, {\n                evt: evt,\n                target: this,\n                currentTarget: this,\n            });\n        }\n        this.pointerPos = undefined;\n        this._pointerPositions = [];\n        this._fire(CONTENT_MOUSEOUT, { evt: evt });\n    };\n    Stage.prototype._mousemove = function (evt) {\n        var _a;\n        if (Global_1.Konva.UA.ieMobile) {\n            return this._touchmove(evt);\n        }\n        this.setPointersPositions(evt);\n        var pointerId = Util_1.Util._getFirstPointerId(evt);\n        var shape;\n        var targetShape = ((_a = this.targetShape) === null || _a === void 0 ? void 0 : _a.getStage()) ? this.targetShape : null;\n        var eventsEnabled = !DragAndDrop_1.DD.isDragging || Global_1.Konva.hitOnDragEnabled;\n        if (eventsEnabled) {\n            shape = this.getIntersection(this.getPointerPosition());\n            if (shape && shape.isListening()) {\n                var differentTarget = targetShape !== shape;\n                if (eventsEnabled && differentTarget) {\n                    if (targetShape) {\n                        targetShape._fireAndBubble(MOUSEOUT, { evt: evt, pointerId: pointerId }, shape);\n                        targetShape._fireAndBubble(MOUSELEAVE, { evt: evt, pointerId: pointerId }, shape);\n                    }\n                    shape._fireAndBubble(MOUSEOVER, { evt: evt, pointerId: pointerId }, targetShape);\n                    shape._fireAndBubble(MOUSEENTER, { evt: evt, pointerId: pointerId }, targetShape);\n                    shape._fireAndBubble(MOUSEMOVE, { evt: evt, pointerId: pointerId });\n                    this.targetShape = shape;\n                }\n                else {\n                    shape._fireAndBubble(MOUSEMOVE, { evt: evt, pointerId: pointerId });\n                }\n            }\n            else {\n                if (targetShape && eventsEnabled) {\n                    targetShape._fireAndBubble(MOUSEOUT, { evt: evt, pointerId: pointerId });\n                    targetShape._fireAndBubble(MOUSELEAVE, { evt: evt, pointerId: pointerId });\n                    this._fire(MOUSEOVER, {\n                        evt: evt,\n                        target: this,\n                        currentTarget: this,\n                        pointerId: pointerId,\n                    });\n                    this.targetShape = null;\n                }\n                this._fire(MOUSEMOVE, {\n                    evt: evt,\n                    target: this,\n                    currentTarget: this,\n                    pointerId: pointerId,\n                });\n            }\n            this._fire(CONTENT_MOUSEMOVE, { evt: evt });\n        }\n        if (evt.cancelable) {\n            evt.preventDefault();\n        }\n    };\n    Stage.prototype._mousedown = function (evt) {\n        if (Global_1.Konva.UA.ieMobile) {\n            return this._touchstart(evt);\n        }\n        this.setPointersPositions(evt);\n        var pointerId = Util_1.Util._getFirstPointerId(evt);\n        var shape = this.getIntersection(this.getPointerPosition());\n        DragAndDrop_1.DD.justDragged = false;\n        Global_1.Konva.listenClickTap = true;\n        if (shape && shape.isListening()) {\n            this.clickStartShape = shape;\n            shape._fireAndBubble(MOUSEDOWN, { evt: evt, pointerId: pointerId });\n        }\n        else {\n            this._fire(MOUSEDOWN, {\n                evt: evt,\n                target: this,\n                currentTarget: this,\n                pointerId: pointerId,\n            });\n        }\n        this._fire(CONTENT_MOUSEDOWN, { evt: evt });\n    };\n    Stage.prototype._mouseup = function (evt) {\n        if (Global_1.Konva.UA.ieMobile) {\n            return this._touchend(evt);\n        }\n        this.setPointersPositions(evt);\n        var pointerId = Util_1.Util._getFirstPointerId(evt);\n        var shape = this.getIntersection(this.getPointerPosition()), clickStartShape = this.clickStartShape, clickEndShape = this.clickEndShape, fireDblClick = false;\n        if (Global_1.Konva.inDblClickWindow) {\n            fireDblClick = true;\n            clearTimeout(this.dblTimeout);\n        }\n        else if (!DragAndDrop_1.DD.justDragged) {\n            Global_1.Konva.inDblClickWindow = true;\n            clearTimeout(this.dblTimeout);\n        }\n        this.dblTimeout = setTimeout(function () {\n            Global_1.Konva.inDblClickWindow = false;\n        }, Global_1.Konva.dblClickWindow);\n        if (shape && shape.isListening()) {\n            this.clickEndShape = shape;\n            shape._fireAndBubble(MOUSEUP, { evt: evt, pointerId: pointerId });\n            if (Global_1.Konva.listenClickTap &&\n                clickStartShape &&\n                clickStartShape._id === shape._id) {\n                shape._fireAndBubble(CLICK, { evt: evt, pointerId: pointerId });\n                if (fireDblClick && clickEndShape && clickEndShape === shape) {\n                    shape._fireAndBubble(DBL_CLICK, { evt: evt, pointerId: pointerId });\n                }\n            }\n        }\n        else {\n            this.clickEndShape = null;\n            this._fire(MOUSEUP, {\n                evt: evt,\n                target: this,\n                currentTarget: this,\n                pointerId: pointerId,\n            });\n            if (Global_1.Konva.listenClickTap) {\n                this._fire(CLICK, {\n                    evt: evt,\n                    target: this,\n                    currentTarget: this,\n                    pointerId: pointerId,\n                });\n            }\n            if (fireDblClick) {\n                this._fire(DBL_CLICK, {\n                    evt: evt,\n                    target: this,\n                    currentTarget: this,\n                    pointerId: pointerId,\n                });\n            }\n        }\n        this._fire(CONTENT_MOUSEUP, { evt: evt });\n        if (Global_1.Konva.listenClickTap) {\n            this._fire(CONTENT_CLICK, { evt: evt });\n            if (fireDblClick) {\n                this._fire(CONTENT_DBL_CLICK, { evt: evt });\n            }\n        }\n        Global_1.Konva.listenClickTap = false;\n        if (evt.cancelable) {\n            evt.preventDefault();\n        }\n    };\n    Stage.prototype._contextmenu = function (evt) {\n        this.setPointersPositions(evt);\n        var shape = this.getIntersection(this.getPointerPosition());\n        if (shape && shape.isListening()) {\n            shape._fireAndBubble(CONTEXTMENU, { evt: evt });\n        }\n        else {\n            this._fire(CONTEXTMENU, {\n                evt: evt,\n                target: this,\n                currentTarget: this,\n            });\n        }\n        this._fire(CONTENT_CONTEXTMENU, { evt: evt });\n    };\n    Stage.prototype._touchstart = function (evt) {\n        var _this = this;\n        this.setPointersPositions(evt);\n        var triggeredOnShape = false;\n        this._changedPointerPositions.forEach(function (pos) {\n            var shape = _this.getIntersection(pos);\n            Global_1.Konva.listenClickTap = true;\n            DragAndDrop_1.DD.justDragged = false;\n            var hasShape = shape && shape.isListening();\n            if (!hasShape) {\n                return;\n            }\n            if (Global_1.Konva.captureTouchEventsEnabled) {\n                shape.setPointerCapture(pos.id);\n            }\n            _this.tapStartShape = shape;\n            shape._fireAndBubble(TOUCHSTART, { evt: evt, pointerId: pos.id }, _this);\n            triggeredOnShape = true;\n            if (shape.isListening() && shape.preventDefault() && evt.cancelable) {\n                evt.preventDefault();\n            }\n        });\n        if (!triggeredOnShape) {\n            this._fire(TOUCHSTART, {\n                evt: evt,\n                target: this,\n                currentTarget: this,\n                pointerId: this._changedPointerPositions[0].id,\n            });\n        }\n        this._fire(CONTENT_TOUCHSTART, { evt: evt });\n    };\n    Stage.prototype._touchmove = function (evt) {\n        var _this = this;\n        this.setPointersPositions(evt);\n        var eventsEnabled = !DragAndDrop_1.DD.isDragging || Global_1.Konva.hitOnDragEnabled;\n        if (eventsEnabled) {\n            var triggeredOnShape = false;\n            var processedShapesIds = {};\n            this._changedPointerPositions.forEach(function (pos) {\n                var shape = PointerEvents.getCapturedShape(pos.id) || _this.getIntersection(pos);\n                var hasShape = shape && shape.isListening();\n                if (!hasShape) {\n                    return;\n                }\n                if (processedShapesIds[shape._id]) {\n                    return;\n                }\n                processedShapesIds[shape._id] = true;\n                shape._fireAndBubble(TOUCHMOVE, { evt: evt, pointerId: pos.id });\n                triggeredOnShape = true;\n                if (shape.isListening() && shape.preventDefault() && evt.cancelable) {\n                    evt.preventDefault();\n                }\n            });\n            if (!triggeredOnShape) {\n                this._fire(TOUCHMOVE, {\n                    evt: evt,\n                    target: this,\n                    currentTarget: this,\n                    pointerId: this._changedPointerPositions[0].id,\n                });\n            }\n            this._fire(CONTENT_TOUCHMOVE, { evt: evt });\n        }\n        if (DragAndDrop_1.DD.isDragging && DragAndDrop_1.DD.node.preventDefault() && evt.cancelable) {\n            evt.preventDefault();\n        }\n    };\n    Stage.prototype._touchend = function (evt) {\n        var _this = this;\n        this.setPointersPositions(evt);\n        var tapEndShape = this.tapEndShape, fireDblClick = false;\n        if (Global_1.Konva.inDblClickWindow) {\n            fireDblClick = true;\n            clearTimeout(this.dblTimeout);\n        }\n        else if (!DragAndDrop_1.DD.justDragged) {\n            Global_1.Konva.inDblClickWindow = true;\n            clearTimeout(this.dblTimeout);\n        }\n        this.dblTimeout = setTimeout(function () {\n            Global_1.Konva.inDblClickWindow = false;\n        }, Global_1.Konva.dblClickWindow);\n        var triggeredOnShape = false;\n        var processedShapesIds = {};\n        var tapTriggered = false;\n        var dblTapTriggered = false;\n        this._changedPointerPositions.forEach(function (pos) {\n            var shape = PointerEvents.getCapturedShape(pos.id) ||\n                _this.getIntersection(pos);\n            if (shape) {\n                shape.releaseCapture(pos.id);\n            }\n            var hasShape = shape && shape.isListening();\n            if (!hasShape) {\n                return;\n            }\n            if (processedShapesIds[shape._id]) {\n                return;\n            }\n            processedShapesIds[shape._id] = true;\n            _this.tapEndShape = shape;\n            shape._fireAndBubble(TOUCHEND, { evt: evt, pointerId: pos.id });\n            triggeredOnShape = true;\n            if (Global_1.Konva.listenClickTap && shape === _this.tapStartShape) {\n                tapTriggered = true;\n                shape._fireAndBubble(TAP, { evt: evt, pointerId: pos.id });\n                if (fireDblClick && tapEndShape && tapEndShape === shape) {\n                    dblTapTriggered = true;\n                    shape._fireAndBubble(DBL_TAP, { evt: evt, pointerId: pos.id });\n                }\n            }\n            if (shape.isListening() && shape.preventDefault() && evt.cancelable) {\n                evt.preventDefault();\n            }\n        });\n        if (!triggeredOnShape) {\n            this._fire(TOUCHEND, {\n                evt: evt,\n                target: this,\n                currentTarget: this,\n                pointerId: this._changedPointerPositions[0].id,\n            });\n        }\n        if (Global_1.Konva.listenClickTap && !tapTriggered) {\n            this.tapEndShape = null;\n            this._fire(TAP, {\n                evt: evt,\n                target: this,\n                currentTarget: this,\n                pointerId: this._changedPointerPositions[0].id,\n            });\n        }\n        if (fireDblClick && !dblTapTriggered) {\n            this._fire(DBL_TAP, {\n                evt: evt,\n                target: this,\n                currentTarget: this,\n                pointerId: this._changedPointerPositions[0].id,\n            });\n        }\n        this._fire(CONTENT_TOUCHEND, { evt: evt });\n        if (Global_1.Konva.listenClickTap) {\n            this._fire(CONTENT_TAP, { evt: evt });\n            if (fireDblClick) {\n                this._fire(CONTENT_DBL_TAP, { evt: evt });\n            }\n        }\n        if (this.preventDefault() && evt.cancelable) {\n            evt.preventDefault();\n        }\n        Global_1.Konva.listenClickTap = false;\n    };\n    Stage.prototype._wheel = function (evt) {\n        this.setPointersPositions(evt);\n        var shape = this.getIntersection(this.getPointerPosition());\n        if (shape && shape.isListening()) {\n            shape._fireAndBubble(WHEEL, { evt: evt });\n        }\n        else {\n            this._fire(WHEEL, {\n                evt: evt,\n                target: this,\n                currentTarget: this,\n            });\n        }\n        this._fire(CONTENT_WHEEL, { evt: evt });\n    };\n    Stage.prototype._pointerdown = function (evt) {\n        if (!Global_1.Konva._pointerEventsEnabled) {\n            return;\n        }\n        this.setPointersPositions(evt);\n        var shape = PointerEvents.getCapturedShape(evt.pointerId) ||\n            this.getIntersection(this.getPointerPosition());\n        if (shape) {\n            shape._fireAndBubble(POINTERDOWN, PointerEvents.createEvent(evt));\n        }\n    };\n    Stage.prototype._pointermove = function (evt) {\n        if (!Global_1.Konva._pointerEventsEnabled) {\n            return;\n        }\n        this.setPointersPositions(evt);\n        var shape = PointerEvents.getCapturedShape(evt.pointerId) ||\n            this.getIntersection(this.getPointerPosition());\n        if (shape) {\n            shape._fireAndBubble(POINTERMOVE, PointerEvents.createEvent(evt));\n        }\n    };\n    Stage.prototype._pointerup = function (evt) {\n        if (!Global_1.Konva._pointerEventsEnabled) {\n            return;\n        }\n        this.setPointersPositions(evt);\n        var shape = PointerEvents.getCapturedShape(evt.pointerId) ||\n            this.getIntersection(this.getPointerPosition());\n        if (shape) {\n            shape._fireAndBubble(POINTERUP, PointerEvents.createEvent(evt));\n        }\n        PointerEvents.releaseCapture(evt.pointerId);\n    };\n    Stage.prototype._pointercancel = function (evt) {\n        if (!Global_1.Konva._pointerEventsEnabled) {\n            return;\n        }\n        this.setPointersPositions(evt);\n        var shape = PointerEvents.getCapturedShape(evt.pointerId) ||\n            this.getIntersection(this.getPointerPosition());\n        if (shape) {\n            shape._fireAndBubble(POINTERUP, PointerEvents.createEvent(evt));\n        }\n        PointerEvents.releaseCapture(evt.pointerId);\n    };\n    Stage.prototype._lostpointercapture = function (evt) {\n        PointerEvents.releaseCapture(evt.pointerId);\n    };\n    Stage.prototype.setPointersPositions = function (evt) {\n        var _this = this;\n        var contentPosition = this._getContentPosition(), x = null, y = null;\n        evt = evt ? evt : window.event;\n        if (evt.touches !== undefined) {\n            this._pointerPositions = [];\n            this._changedPointerPositions = [];\n            Util_1.Collection.prototype.each.call(evt.touches, function (touch) {\n                _this._pointerPositions.push({\n                    id: touch.identifier,\n                    x: (touch.clientX - contentPosition.left) / contentPosition.scaleX,\n                    y: (touch.clientY - contentPosition.top) / contentPosition.scaleY,\n                });\n            });\n            Util_1.Collection.prototype.each.call(evt.changedTouches || evt.touches, function (touch) {\n                _this._changedPointerPositions.push({\n                    id: touch.identifier,\n                    x: (touch.clientX - contentPosition.left) / contentPosition.scaleX,\n                    y: (touch.clientY - contentPosition.top) / contentPosition.scaleY,\n                });\n            });\n        }\n        else {\n            x = (evt.clientX - contentPosition.left) / contentPosition.scaleX;\n            y = (evt.clientY - contentPosition.top) / contentPosition.scaleY;\n            this.pointerPos = {\n                x: x,\n                y: y,\n            };\n            this._pointerPositions = [{ x: x, y: y, id: Util_1.Util._getFirstPointerId(evt) }];\n            this._changedPointerPositions = [\n                { x: x, y: y, id: Util_1.Util._getFirstPointerId(evt) },\n            ];\n        }\n    };\n    Stage.prototype._setPointerPosition = function (evt) {\n        Util_1.Util.warn('Method _setPointerPosition is deprecated. Use \"stage.setPointersPositions(event)\" instead.');\n        this.setPointersPositions(evt);\n    };\n    Stage.prototype._getContentPosition = function () {\n        if (!this.content || !this.content.getBoundingClientRect) {\n            return {\n                top: 0,\n                left: 0,\n                scaleX: 1,\n                scaleY: 1,\n            };\n        }\n        var rect = this.content.getBoundingClientRect();\n        return {\n            top: rect.top,\n            left: rect.left,\n            scaleX: rect.width / this.content.clientWidth || 1,\n            scaleY: rect.height / this.content.clientHeight || 1,\n        };\n    };\n    Stage.prototype._buildDOM = function () {\n        this.bufferCanvas = new Canvas_1.SceneCanvas({\n            width: this.width(),\n            height: this.height(),\n        });\n        this.bufferHitCanvas = new Canvas_1.HitCanvas({\n            pixelRatio: 1,\n            width: this.width(),\n            height: this.height(),\n        });\n        if (!Global_1.Konva.isBrowser) {\n            return;\n        }\n        var container = this.container();\n        if (!container) {\n            throw 'Stage has no container. A container is required.';\n        }\n        container.innerHTML = EMPTY_STRING;\n        this.content = document.createElement('div');\n        this.content.style.position = RELATIVE;\n        this.content.style.userSelect = 'none';\n        this.content.className = KONVA_CONTENT;\n        this.content.setAttribute('role', 'presentation');\n        container.appendChild(this.content);\n        this._resizeDOM();\n    };\n    Stage.prototype.cache = function () {\n        Util_1.Util.warn('Cache function is not allowed for stage. You may use cache only for layers, groups and shapes.');\n        return this;\n    };\n    Stage.prototype.clearCache = function () {\n        return this;\n    };\n    Stage.prototype.batchDraw = function () {\n        this.children.each(function (layer) {\n            layer.batchDraw();\n        });\n        return this;\n    };\n    return Stage;\n}(Container_1.Container));\nexports.Stage = Stage;\nStage.prototype.nodeType = STAGE;\nGlobal_2._registerNode(Stage);\nFactory_1.Factory.addGetterSetter(Stage, 'container');\n"]},"metadata":{},"sourceType":"script"}